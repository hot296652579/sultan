{"version":3,"sources":["assets/games/roulette/script/view/RouletteTotalRecordView.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,4FAAoE;AACpE,uFAA+D;AAC/D,iGAAyE;AACzE,uEAAoE;AACpE,6EAA0E;AAC1E,0FAAkE;AAClE,8EAAsD;AACtD,uEAAmF;AAEnF,kFAAkF;AAClF,0EAAuE;AAEvE,yEAAmE;AACnE,oFAA4D;AAC5D,oFAA4D;AAC5D,wEAAgD;AAEhD,OAAO;AACP,MAAM,UAAU,GAAW,EAAE,CAAC;AAC9B,OAAO;AACP,MAAM,UAAU,GAAW,QAAQ,CAAC;AACpC,cAAc;AACd,MAAM,gBAAgB,GAAW,CAAC,CAAC,CAAC;AAEpC,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,GAAG,EAAE,CAAC,UAAU,CAAC;AAI5C,IAAqB,uBAAuB,GAA5C,MAAqB,uBAAwB,SAAQ,gBAAM;IAA3D;;QAIY,cAAS,GAAa,IAAI,CAAC;QAG3B,kBAAa,GAAkB,IAAI,CAAC;QAGpC,aAAQ,GAAa,IAAI,CAAC;QAElC,SAAS;QACD,aAAQ,GAAY,IAAI,CAAC;QACjC,SAAS;QACD,kBAAa,GAAiB,IAAI,CAAC;QAC3C,SAAS;QACD,gBAAW,GAAY,KAAK,CAAC;QACrC,WAAW;QACH,wBAAmB,GAA8B,IAAI,CAAC;IAuIlE,CAAC;IArIU,MAAM,CAAC,YAAY;QACtB,OAAO,iCAAiC,CAAC;IAC7C,CAAC;IAED,MAAM;QACF,KAAK,CAAC,MAAM,EAAE,CAAC;QAEf,IAAI,CAAC,QAAQ,EAAE,CAAC;QAChB,IAAI,CAAC,QAAQ,EAAE,CAAC;QAEhB,IAAI,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC;QACxC,IAAI,CAAC,sBAAsB,CAAC,KAAK,CAAC,CAAC;IACvC,CAAC;IAED,KAAK;IAEL,CAAC;IAEM,IAAI,CAAC,IAAY;QACpB,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAEjB,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAC5B,CAAC;IAEO,QAAQ;QACZ,IAAI,CAAC,QAAQ,GAAG,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,iBAAO,CAAC,CAAC;QACvC,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,sBAAY,CAAC,CAAC;QACjD,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;QACzB,IAAI,CAAC,mBAAmB,GAAG,EAAE,CAAC;IAClC,CAAC;IAEO,QAAQ;QACZ,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;IACtC,CAAC;IAED,aAAa;QACT,KAAK,CAAC,aAAa,EAAE,CAAC;QAEtB,IAAI,gCAAsB,EAAE;YACxB,IAAI,CAAC,aAAa,CAAC,mBAAQ,CAAC,eAAe,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAC;SACvE;QAED,IAAI,CAAC,aAAa,CAAC,8BAA8B,EAAE,IAAI,CAAC,8BAA8B,CAAC,CAAC;IAE5F,CAAC;IAED,gBAAgB;QACZ,IAAI,CAAC,aAAa,CAAC,gBAAgB,CAAC,iBAAO,CAAC,YAAY,CAAC,mBAAmB,EAAE,IAAI,CAAC,CAAC,CAAC;IAEzF,CAAC;IAEO,eAAe;QACnB,IAAI,EAAE,GAAW,gBAAgB,CAAC;QAClC,IAAI,IAAI,CAAC,mBAAmB,CAAC,MAAM,GAAG,CAAC,EAAE;YACrC,IAAI,cAAc,GAA4B,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,mBAAmB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;YAC5G,EAAE,GAAG,cAAc,CAAC,KAAK,CAAC;SAC7B;QACD,OAAO,EAAE,CAAC;IACd,CAAC;IAED;;;OAGG;IACK,sBAAsB,CAAC,KAAc;QACzC,IAAI,mBAAS,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE;YACzB,KAAK,GAAG,gBAAgB,CAAC;SAC5B;QAED,IAAI,IAAI,GAA+B;YACnC,KAAK,EAAE,iBAAO,CAAC,UAAU,CAAC,WAAW,EAAE;YACvC,KAAK,EAAE,UAAU;YACjB,KAAK;SACR,CAAA;QACD,IAAI,GAAG,GAAG,YAAG,CAAC,sBAAsB,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAClD,IAAI,MAAM,GAAG,YAAG,CAAC,sBAAsB,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC;QAC7D,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,YAAG,CAAC,sBAAsB,EAAE,YAAG,CAAC,oBAAoB,CAAC,sBAAsB,EAAE,MAAM,CAAC,CAAC;IAC9G,CAAC;IAEO,8BAA8B,CAAC,IAAiC;QACpE,IAAI,IAAI,CAAC,KAAK,KAAK,CAAC,EAAE;YAClB,mBAAS,CAAC,UAAU,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACjC,OAAO;SACV;QAED,IAAI,IAAI,CAAC,KAAK,KAAK,gBAAgB,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,IAAI,CAAC,EAAE;YAC7D,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;YACjC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;SACtC;aAAM;YACH,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;YAClC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;SACrC;QAED,SAAS;QACT,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,UAAU,CAAC;QAGpD,IAAI,IAAI,CAAC,KAAK,KAAK,gBAAgB,EAAE;YACjC,IAAI,CAAC,mBAAmB,GAAG,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACnD,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;SACpC;aAAM;YACH,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,mBAAmB,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACzE,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;SACvC;IACL,CAAC;IAEM,OAAO,CAAC,UAAe,EAAE,UAAe,EAAE,IAAa;QAC1D,QAAQ,UAAU,EAAE;YAChB,KAAK,UAAU;gBACX,IAAI,CAAC,KAAK,EAAE,CAAC;gBACb,MAAM;SACb;IACL,CAAC;IAED;;;OAGG;IACK,SAAS,CAAC,MAAgB;QAC9B,IAAI,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC;IACnC,CAAC;IAED;;OAEG;IACK,YAAY,CAAC,MAAgB;QACjC,IAAI,IAAI,CAAC,WAAW,EAAE;YAClB,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,6BAA6B,CAAC,CAAC;YAC5C,OAAO;SACV;QACD,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC,CAAC;IACxD,CAAC;CAEJ,CAAA;AAtJG;IADC,QAAQ,CAAC,kBAAQ,CAAC;0DACgB;AAGnC;IADC,QAAQ,CAAC,uBAAa,CAAC;8DACoB;AAG5C;IADC,QAAQ,CAAC,kBAAQ,CAAC;yDACe;AAVjB,uBAAuB;IAF3C,OAAO;IACP,0BAAa,CAAC,2BAAY,CAAC,QAAQ,CAAC;GAChB,uBAAuB,CA0J3C;kBA1JoB,uBAAuB","file":"","sourceRoot":"/","sourcesContent":["import ListView from \"../../../../script/common/component/ListView\";\nimport NoneItem from \"../../../../script/common/item/NoneItem\";\nimport TitleItemPage from \"../../../../script/common/item/TitleItemPage\";\nimport { Manager } from \"../../../../script/common/manager/Manager\";\nimport { LobbyService } from \"../../../../script/common/net/LobbyService\";\nimport TypeUtils from \"../../../../script/common/utils/TypeUtils\";\nimport AppData from \"../../../../script/data/AppData\";\nimport { ENABLE_CHANGE_LANGUAGE } from \"../../../../script/framework/base/Defines\";\nimport { IController } from \"../../../../script/framework/controller/Controller\";\nimport { injectService } from \"../../../../script/framework/decorator/Decorators\";\nimport { EventApi } from \"../../../../script/framework/event/EventApi\";\nimport DateUtils from \"../../../../script/framework/extentions/DateUtils\";\nimport { MST } from \"../../../../script/framework/external/protoc\";\nimport UIView from \"../../../../script/framework/ui/UIView\";\nimport PanelHelp from \"../../../../script/msgbox/PanelHelp\";\nimport RouletteData from \"../data/RouletteData\";\n\n// 每页数量\nconst PAGE_COUNT: number = 20;\n// 一天毫秒\nconst ONE_DAY_MS: number = 86400000;\n// 默认首次请求分页 ID\nconst DEFAULT_FIRST_ID: number = -1;\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\n@injectService(LobbyService.instance)\nexport default class RouletteTotalRecordView extends UIView implements IController<LobbyService> {\n    service: LobbyService;\n\n    @property(ListView)\n    private lsvRecord: ListView = null;\n\n    @property(TitleItemPage)\n    private titleItemPage: TitleItemPage = null;\n\n    @property(NoneItem)\n    private noneItem: NoneItem = null;\n\n    // App 数据\n    private _appData: AppData = null;\n    // App 数据\n    private _rouletteData: RouletteData = null;\n    // 是否最后一页\n    private _isLastPage: boolean = false;\n    // 当天历史数据列表\n    private _gameRecordDataList: MST.IRouletteGameRecord[] = null;\n\n    public static getPrefabUrl() {\n        return \"prefabs/RouletteTotalRecordView\";\n    }\n\n    onLoad() {\n        super.onLoad();\n\n        this.initData();\n        this.initView();\n\n        let round = this._rouletteData.curRound;\n        this.C2R_GetGameRecords_Req(round);\n    }\n\n    start() {\n\n    }\n\n    public show(args?: any[]): void {\n        super.show(args);\n\n        this.onLanguageChange();\n    }\n\n    private initData(): void {\n        this._appData = G.DataMgr.get(AppData);\n        this._rouletteData = G.DataMgr.get(RouletteData);\n        this._isLastPage = false;\n        this._gameRecordDataList = [];\n    }\n\n    private initView(): void {\n        this.noneItem.node.active = false;\n    }\n\n    bindingEvents() {\n        super.bindingEvents();\n\n        if (ENABLE_CHANGE_LANGUAGE) {\n            this.registerEvent(EventApi.CHANGE_LANGUAGE, this.onLanguageChange);\n        }\n\n        this.registerEvent(\"Event_R2C_GetGameRecords_Res\", this.onEvent_R2C_GetGameRecords_Res);\n\n    }\n\n    onLanguageChange() {\n        this.titleItemPage.languagePageName(Manager.makeLanguage(\"labRecordPageName\", true));\n\n    }\n\n    private getLastRecordId(): number {\n        let id: number = DEFAULT_FIRST_ID;\n        if (this._gameRecordDataList.length > 0) {\n            let lastRecordData: MST.IRouletteGameRecord = this._gameRecordDataList[this._gameRecordDataList.length - 1];\n            id = lastRecordData.round;\n        }\n        return id;\n    }\n\n    /**\n     * 查询历史记录\n     * @param timestamp {number} 查询哪天时间戳\n     */\n    private C2R_GetGameRecords_Req(round?: number): void {\n        if (TypeUtils.isNull(round)) {\n            round = DEFAULT_FIRST_ID;\n        }\n\n        let data: MST.C2R_GetGameRecords_Req = {\n            RpcId: Manager.netManager.getNewSeqId(),\n            limit: PAGE_COUNT,\n            round\n        }\n        let req = MST.C2R_GetGameRecords_Req.create(data);\n        let buffer = MST.C2R_GetGameRecords_Req.encode(req).finish();\n        this.service.sendMsg(MST.C2R_GetGameRecords_Req, MST.OuterOpcode_Roulette.C2R_GetGameRecords_Req, buffer);\n    }\n\n    private onEvent_R2C_GetGameRecords_Res(data: MST.IR2C_GetGameRecords_Res): void {\n        if (data.Error !== 0) {\n            PanelHelp.showErrTip(data.Error);\n            return;\n        }\n\n        if (data.round === DEFAULT_FIRST_ID && data.records.length <= 0) {\n            this.noneItem.node.active = true;\n            this.lsvRecord.node.active = false;\n        } else {\n            this.noneItem.node.active = false;\n            this.lsvRecord.node.active = true;\n        }\n\n        // 是否最后一页\n        this._isLastPage = data.records.length < PAGE_COUNT;\n\n\n        if (data.round === DEFAULT_FIRST_ID) {\n            this._gameRecordDataList = [].concat(data.records);\n            this.lsvRecord.set(data.records);\n        } else {\n            this._gameRecordDataList = this._gameRecordDataList.concat(data.records);\n            this.lsvRecord.insert(data.records);\n        }\n    }\n\n    public onClick(ButtonName: any, ButtonNode: any, data?: string): void {\n        switch (ButtonName) {\n            case \"btnClose\":\n                this.close();\n                break;\n        }\n    }\n\n    /**\n     * 上拉回调\n     * @param target \n     */\n    private onPullTop(target: ListView): void {\n        this.C2R_GetGameRecords_Req(0);\n    }\n\n    /**\n     * 下拉回调\n     */\n    private onPullBottom(target: ListView): void {\n        if (this._isLastPage) {\n            G.Logger.log(\"Crash 浏览总历史记录 已是最后一页 无需请求翻页\");\n            return;\n        }\n        this.C2R_GetGameRecords_Req(this.getLastRecordId());\n    }\n\n}\n"]}