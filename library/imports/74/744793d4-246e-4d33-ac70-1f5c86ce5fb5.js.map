{"version":3,"sources":["assets/script/common/component/ScroViewCtrl.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import PanelHelp from \"../../msgbox/PanelHelp\";\nimport { i18n } from \"../language/LanguageImpl\";\nimport ScroViewPlus from \"./ScroViewPlus\";\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class ScroViewCtrl extends cc.Component {\n\n    @property(ScroViewPlus)\n    scroViewPlus: ScroViewPlus = null;\n\n    @property(cc.Prefab)\n    itemPrefab: cc.Prefab = null;\n\n    @property(cc.String)\n    itemScriptName = '';\n\n    public onItemClickCallback: any = null\n\n    public dataList: any = []\n\n    private _initItem(itemId: number) {\n        let itemNode = cc.instantiate(this.itemPrefab);\n        itemNode.parent = this.scroViewPlus.content;\n        let itemScriptCom = itemNode.getComponent(this.itemScriptName)\n        itemScriptCom.updateItem(this.dataList[itemId], itemId, this.onItemClickCallback)\n    }\n\n\n    /**\n     * 分帧加载\n     * @param childNodeCount 子节点数量\n     * @param removeHistoryChildren 是否删除历史子节点\n     */\n    async framingLoad(childNodeCount: number, removeHistoryChildren: boolean = true) {\n        // PanelHelp.showLoading(i18n.WAIT.LOADING);\n        this.unscheduleAllCallbacks()\n        if (removeHistoryChildren) {\n            this.scroViewPlus.content.removeAllChildren();\n        }\n        await this.executePreFrame(this._getItemGenerator(childNodeCount), 1);\n        this.scroViewPlus.optDc();\n        // PanelHelp.hideLoading()\n    }\n\n    /**\n     * 分帧执行 Generator 逻辑\n     *\n     * @param generator 生成器\n     * @param duration 持续时间（ms），每次执行 Generator 的操作时，最长可持续执行时长。假设值为8ms，那么表示1帧（总共16ms）下，分出8ms时间给此逻辑执行\n     */\n    private executePreFrame(generator: Generator, duration: number) {\n        return new Promise<void>((resolve, reject) => {\n            let gen = generator;\n            // 创建执行函数\n            let execute = () => {\n                // 执行之前，先记录开始时间\n                let startTime = new Date().getTime();\n\n                // 然后一直从 Generator 中获取已经拆分好的代码段出来执行\n                for (let iter = gen.next(); ; iter = gen.next()) {\n                    // 判断是否已经执行完所有 Generator 的小代码段，如果是的话，那么就表示任务完成\n                    if (iter == null || iter.done) {\n                        resolve();\n                        return;\n                    }\n\n                    // 每执行完一段小代码段，都检查一下是否已经超过我们分配的本帧，这些小代码端的最大可执行时间\n                    if (new Date().getTime() - startTime > duration) {\n                        // 如果超过了，那么本帧就不在执行，开定时器，让下一帧再执行\n                        this.scheduleOnce(() => {\n                            execute();\n                        });\n                        return;\n                    }\n                }\n            };\n\n            // 运行执行函数\n            execute();\n        });\n    }\n\n    private *_getItemGenerator(length: number) {\n        for (let i = 0; i < length; i++) {\n            yield this._initItem(i);\n        }\n    }\n\n\n    removeItem(itemID) {\n        this.scroViewPlus.content.children.forEach((removeItem, index) => {\n            let _itemID = removeItem.getComponent(this.itemScriptName).getItemId();\n            if (_itemID == itemID) {\n                this.dataList.splice(itemID, 1);\n                this.scroViewPlus.content.removeChild(removeItem);\n            }\n        });\n        this.updateItem();\n    }\n\n    updateItem() {\n        this.scroViewPlus.content.children.forEach((updateItem, itemId) => {\n            updateItem.getComponent(this.itemScriptName).updateItem(this.dataList[itemId], itemId, this.onItemClickCallback);\n        });\n        this.scroViewPlus.content.getComponent(cc.Layout).updateLayout();\n    }\n}\n"]}