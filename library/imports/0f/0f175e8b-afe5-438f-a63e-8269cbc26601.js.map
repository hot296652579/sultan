{"version":3,"sources":["assets/script/common/manager/GameManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { getSingleton } from \"../../framework/base/Singleton\";\nimport { LogicEvent } from \"../event/LogicEvent\";\nimport { HotUpdate, AssetManagerCode, AssetManagerState, SubGameUpdateType, GameConfig } from \"../base/HotUpdate\";\nimport { HallEvent } from \"../../hall/HallEvent\";\nimport PanelHelp from \"../../msgbox/PanelHelp\";\nimport { i18n } from \"../language/LanguageImpl\";\nimport { Manager } from \"./Manager\";\n\nexport function gameManager() {\n   return getSingleton(GameManager);\n}\n\nclass GameManager {\n   private static _instance: GameManager = null;\n   private updateFailedNum = 0;\n   public static Instance() { return this._instance || (this._instance = new GameManager()); }\n   private curGame: GameConfig = null;\n   private isLoading = false;\n\n   /**\n    * 外部接口 进入游戏\n    * @param areaType\n    */\n   public enterGame(config: GameConfig) {//进入游戏（输入房间号）\n      if (this.isLoading) {\n         cc.log(\"正在更新游戏，请稍等\");\n         // PanelHelp.showMsgBox(\"\", i18n.Tips.GameIsLoading);\n         return;\n      }\n      // PanelHelp.showLoading(i18n.WAIT.LOADING)\n      this.curGame = config;\n      this.isLoading = true;\n\n      if (!HotUpdate.allGameConfig[this.curGame.subpackageName]) {\n         HotUpdate.allGameConfig[this.curGame.subpackageName] = config;\n      }\n\n      let versionInfo = HotUpdate.allGameConfig[this.curGame.subpackageName];\n      if (HotUpdate.subGameUpdateType == SubGameUpdateType.Normal) {\n         if (versionInfo.isLoaded) {\n            cc.log(`游戏已经加载过了`);\n            this.onGameReady();\n         } else {\n            //检测游戏版本更新\n            dispatch(\"onCheckUpdateGameStart\", this.curGame.subpackageName);\n            this.checkUpdate(versionInfo);\n         }\n      } else {\n         dispatch(\"onCheckUpdateGameStart\", this.curGame.subpackageName);\n         this.checkUpdate(versionInfo);\n      }\n   }\n   public enterGameNoUpdate(config: GameConfig) {\n      if (this.isLoading) {\n         cc.log(\"正在更新游戏，请稍等\");\n         PanelHelp.showMsgBox(\"\", i18n.Tips.GameIsLoading)\n         return;\n      }\n      // PanelHelp.showLoading(i18n.WAIT.LOADING)\n      this.curGame = config;\n      this.isLoading = true;\n\n      if (!HotUpdate.allGameConfig[this.curGame.subpackageName]) {\n         HotUpdate.allGameConfig[this.curGame.subpackageName] = config;\n      }\n\n      let versionInfo = HotUpdate.allGameConfig[this.curGame.subpackageName];\n      if (versionInfo.isLoaded) {\n         cc.log(`游戏已经加载过了`);\n         this.onGameReady();\n      } else {\n         this.loadSubpackage();\n      }\n\n   }\n   private onGameReady() {\n      if (this.isLoading) {\n         this.isLoading = false;\n      }\n      dispatch(LogicEvent.ENTER_GAME_READY, this.curGame.subpackageName);\n   }\n\n   /**@description 检测子游戏更新 */\n   private checkUpdate(versionInfo: GameConfig) {\n      let self = this;\n      cc.log(`检测更新信息:${versionInfo.gameName}(${versionInfo.subpackageName})`);\n      // dispatch(\"onCheckUpdateGameStart\", this.curGame.subpackageName);\n      HotUpdate.checkGameUpdate(this.curGame.subpackageName, (code, state) => {\n         if (code == AssetManagerCode.NEW_VERSION_FOUND) {\n            //有新版本\n            HotUpdate.onDownload = this.onDownload.bind(this);\n            cc.log(`检测到${versionInfo.gameName}(${versionInfo.subpackageName})有新的版本`);\n            HotUpdate.hotUpdate();\n            PanelHelp.hideLoading()\n            dispatch(\"CloseInviteView\");\n            dispatch(\"onCheckUpdateGameEnd\", this.curGame.subpackageName);\n         } else if (state == AssetManagerState.TRY_DOWNLOAD_FAILED_ASSETS) {\n            //尝试重新下载之前下载失败的文件\n            HotUpdate.onDownload = this.onDownload.bind(this);\n            cc.log(`正在尝试重新下载之前下载失败的资源`);\n            HotUpdate.downloadFailedAssets();\n         } else if (code == AssetManagerCode.UPDATE_FINISHED) {\n            //更新完成\n            this.isLoading = false;\n            let gameConfig = HotUpdate.getGameLocalName(this.curGame.subpackageName);\n            dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: 1.1, config: gameConfig });\n            dispatch(\"onCheckUpdateGameEnd\", this.curGame.subpackageName);\n            // PanelHelp.hideLoading()\n         } else if (code == AssetManagerCode.ALREADY_UP_TO_DATE) {\n            dispatch(\"onCheckUpdateGameEnd\", this.curGame.subpackageName);\n            //已经是最新版本\n            if (versionInfo.isLoaded) {\n               self.onGameReady();\n            } else {\n               self.loadSubpackage();\n            }\n         } else if (code == AssetManagerCode.ERROR_DOWNLOAD_MANIFEST ||\n            code == AssetManagerCode.ERROR_NO_LOCAL_MANIFEST ||\n            code == AssetManagerCode.ERROR_PARSE_MANIFEST) {\n            //下载manifest文件失败\n            this.isLoading = false;\n            let content = \"下载版本文件失败!\";\n            if (code == AssetManagerCode.ERROR_NO_LOCAL_MANIFEST) {\n               content = \"找不到版本文件!\";\n            } else if (code == AssetManagerCode.ERROR_PARSE_MANIFEST) {\n               content = \"版本文件解析错误!\";\n            }\n            //Manager.toast.show(content);\n         } else if (code == AssetManagerCode.CHECKING) {\n            //当前正在检测更新\n            cc.log(`正在检测更新!!`);\n         } else {\n            this.isLoading = false;\n            cc.log(`检测更新当前状态 code : ${code} state : ${state}`);\n         }\n      });\n   }\n\n   private loadSubpackage() {\n      cc.log(`updateGame : ${this.curGame.subpackageName}`);\n      let me = this;\n      //加载子包\n      let versionInfo = HotUpdate.allGameConfig[this.curGame.subpackageName];\n      cc.assetManager.loadBundle(versionInfo.subpackageName, (err: Error, bundle: cc.AssetManager.Bundle) => {\n         me.isLoading = false;\n         //Manager.loading.hide();\n         if (err) {\n            cc.error(`load subpackage : ${versionInfo.subpackageName} fail !!!`);\n            //Manager.toast.show(`加载${versionInfo.subpackageName}失败!`);\n            versionInfo.isLoaded = false;\n         } else {\n            cc.log(`load subpackage : ${versionInfo.subpackageName} success !!!`);\n            versionInfo.isLoaded = true;\n            me.onGameReady();\n         }\n      });\n   }\n   private onDownload(\n      downloadedBytes: number,\n      totalBytes: number,\n      downloadedFiles: number,\n      totalFiles: number,\n      percent: number,\n      percentByFile: number,\n      code: AssetManagerCode,\n      state: AssetManagerState,\n      needRestart: boolean) {\n      if (CC_DEBUG) cc.log(`\ndownloadedBytes : ${downloadedBytes}\ntotalBytes : ${totalBytes}\ndownloadedFiles : ${downloadedFiles}\ntotalFiles : ${totalFiles}\npercent : ${percent}\npercentByFile : ${percentByFile}\ncode : ${code}\nstate : ${state}\nneedRestart : ${needRestart}\n`);\n      let newPercent = 0;\n\n      /**\n       *  @description 找不到本地mainfest文件\n    ERROR_NO_LOCAL_MANIFEST,\n    @description 下载manifest文件错误 \n    ERROR_DOWNLOAD_MANIFEST,\n    /**@description 解析manifest文件错误 \n    ERROR_PARSE_MANIFEST,\n    /**@description 找到新版本 \n    NEW_VERSION_FOUND,\n    /**@description 当前已经是最新版本 \n    ALREADY_UP_TO_DATE,\n    /**@description 更新下载进度中 \n    UPDATE_PROGRESSION,\n    /**@description 资源更新中 \n    ASSET_UPDATED,\n    /**@description 更新错误 \n    ERROR_UPDATING,\n    /**@description 更新完成 \n    UPDATE_FINISHED,\n    /**@description 更新失败 \n    UPDATE_FAILED,\n    /**@description 解压资源失败 \n    ERROR_DECOMPRESS,\n       */\n\n      let gameConfig = HotUpdate.getGameLocalName(this.curGame.subpackageName);\n\n      if (code == AssetManagerCode.UPDATE_PROGRESSION) {\n         newPercent = percentByFile == Number.NaN ? 0 : percentByFile;\n         let failePercent = Manager.localStorage.getItem(gameConfig.gameName + \"HotUpdateFailePercent\")\n         if (failePercent && failePercent > newPercent) {\n            newPercent = failePercent\n         }\n         dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent, config: gameConfig });\n      } else if (code == AssetManagerCode.ALREADY_UP_TO_DATE) {\n         newPercent = 1;\n         dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent, config: gameConfig });\n      } else if (code == AssetManagerCode.UPDATE_FINISHED) {\n         newPercent = 1.1;\n         cc.log(`更新${gameConfig.gameName}成功`);\n         if (!needRestart) {\n            //不需要重启//直接加载子游戏进入\n            // cc.log(`正在加载${gameConfig.gameName}`);\n            // this.loadSubpackage(); // 更新完了不进游戏\n         }\n         this.isLoading = false;\n         this.updateFailedNum = 0;\n         Manager.localStorage.setItem(gameConfig.gameName + \"HotUpdateFailePercent\", 0)\n         setTimeout(() => {\n            dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent, config: gameConfig });\n         }, 500)\n\n      } else if (code == AssetManagerCode.UPDATE_FAILED ||\n         code == AssetManagerCode.ERROR_NO_LOCAL_MANIFEST ||\n         code == AssetManagerCode.ERROR_DOWNLOAD_MANIFEST ||\n         code == AssetManagerCode.ERROR_PARSE_MANIFEST ||\n         code == AssetManagerCode.ERROR_DECOMPRESS) {\n\n         let failePercent = Manager.localStorage.getItem(gameConfig.gameName + \"HotUpdateFailePercent\")\n         if (!failePercent) {\n            Manager.localStorage.setItem(gameConfig.gameName + \"HotUpdateFailePercent\", percent)\n         }\n         this.updateFailedNum++\n         if (this.updateFailedNum < 4) {//失败后自动更新\n            let versionInfo = HotUpdate.allGameConfig[this.curGame.subpackageName];\n            this.checkUpdate(versionInfo)\n         } else {\n            newPercent = -1;\n            this.isLoading = false;\n            cc.error(`更新${gameConfig.gameName}失败`);\n            dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent, config: gameConfig });\n         }\n\n      }\n   }\n}\n"]}