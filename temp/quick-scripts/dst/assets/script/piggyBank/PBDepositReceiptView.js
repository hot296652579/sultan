
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/script/piggyBank/PBDepositReceiptView.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '7e378u8JLZDOrA5NwpmtstB', 'PBDepositReceiptView');
// script/piggyBank/PBDepositReceiptView.ts

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const LanguageImpl_1 = require("../common/language/LanguageImpl");
const Manager_1 = require("../common/manager/Manager");
const CommonService_1 = require("../common/net/CommonService");
const LobbyService_1 = require("../common/net/LobbyService");
const Decorators_1 = require("../framework/decorator/Decorators");
const protoc_1 = require("../framework/external/protoc");
const UIView_1 = __importDefault(require("../framework/ui/UIView"));
const PanelHelp_1 = __importDefault(require("../msgbox/PanelHelp"));
const PBDepositReceiptItemNode_1 = __importDefault(require("./PBDepositReceiptItemNode"));
const PiggyBankData_1 = __importDefault(require("./PiggyBankData"));
const { ccclass, property } = cc._decorator;
// 默认每页请求行数
const DEFAULT_ROW = 30;
// 行间隔高度
const INTERVAL_ROW_HEIGHT = 10;
let PBDepositReceiptView = class PBDepositReceiptView extends UIView_1.default {
    constructor() {
        super(...arguments);
        this.scvList = null;
        this.imgNoData = null;
        this.pfbPBDepositReceiptItemNode = null;
        this.imgBase = null;
        // 当前页
        this.m_currPage = 1;
        // 总页
        this.m_totalPage = 0;
        // 数据
        this.m_data = [];
        // 标记是否拼接完数据
        this.m_mapTagList = new Map();
        // 是否分帧加载完成
        this.m_isFrameLoadDone = false;
        // 单项宽高
        this.m_itemSize = null;
        // 保存每条操作的脚本
        this.m_mapOperateSrc = new Map();
    }
    static getPrefabUrl() {
        return "piggyBank/prefabs/PBDepositReceiptView";
    }
    onLoad() {
        super.onLoad();
        this.content = this.node.getChildByName('imgBg');
        this.initView();
    }
    start() {
        if (this.imgBase) {
            let labTime = this.imgBase.getChildByName('labTime');
            labTime.getComponent(cc.Label).language = LanguageImpl_1.i18n.PIGGY_BANK.TIME;
            let labOperationAmount, labInterestRate, labExpectedReturn, labTimeLeft, labOperate;
            labOperationAmount = this.imgBase.getChildByName('labOperationAmount');
            labOperationAmount.getComponent(cc.Label).language = LanguageImpl_1.i18n.PIGGY_BANK.OPERATION_AMOUNT;
            labInterestRate = this.imgBase.getChildByName('labInterestRate');
            labInterestRate.getComponent(cc.Label).language = LanguageImpl_1.i18n.PIGGY_BANK.INTERESRATE;
            labExpectedReturn = this.imgBase.getChildByName('labExpectedReturn');
            labExpectedReturn.getComponent(cc.Label).language = LanguageImpl_1.i18n.PIGGY_BANK.EXPECTEDRETURN;
            labTimeLeft = this.imgBase.getChildByName('labTimeLeft');
            labTimeLeft.getComponent(cc.Label).language = LanguageImpl_1.i18n.PIGGY_BANK.TIMELEFT;
            labOperate = this.imgBase.getChildByName('labOperate');
            labOperate.getComponent(cc.Label).language = LanguageImpl_1.i18n.PIGGY_BANK.OPERATE;
        }
    }
    bindingEvents() {
        this.scvList.node.on("scroll-to-bottom", this.onScrollToBottom, this);
        this.registerEvent(Decorators_1.makeKey(CommonService_1.serverType.Lobby, CommonService_1.protoPackage.hall.HallCmd.CMD_INCOME_BREAKDOWN), this.onIncomeBreakdown);
        this.registerEvent(Decorators_1.makeKey(CommonService_1.serverType.Lobby, CommonService_1.protoPackage.hall.HallCmd.CMD_EXTRACT_AMOUNT), this.onExtractAmount);
        this.registerEvent(Decorators_1.makeKey(CommonService_1.serverType.Lobby, CommonService_1.protoPackage.hall.HallCmd.CMD_CANCEL_STORED_AMOUNT), this.onCancelStoredAmount);
    }
    show() {
        super.show();
        this.showWithAction(true);
        this.reqPageData();
    }
    initView() {
        this.imgNoData.node.active = false;
        let itemNode = cc.instantiate(this.pfbPBDepositReceiptItemNode);
        this.m_itemSize = itemNode.getContentSize();
    }
    reqPageData() {
        let req = CommonService_1.protoPackage.hall.IncomeBreakdownReq.create({ curPage: this.m_currPage, pageCount: DEFAULT_ROW });
        let buffer = CommonService_1.protoPackage.hall.IncomeBreakdownReq.encode(req).finish();
        this.service.sendMsg(CommonService_1.serverType.Lobby, CommonService_1.protoPackage.hall.HallCmd.CMD_INCOME_BREAKDOWN, buffer);
    }
    onScrollToBottom() {
        if (!this.m_isFrameLoadDone) {
            G.Logger.log("未加载完成 item 资源，无法获取最新数据");
            return;
        }
        if (this.m_currPage >= this.m_totalPage) {
            G.Logger.log("资源已加载完成，无法继续获取数据");
            return;
        }
        ++this.m_currPage;
        this.reqPageData();
    }
    onIncomeBreakdown(data) {
        if (data.statusMsg.status !== 0) {
            PanelHelp_1.default.showTip(Manager_1.Manager.makeLanguage("ERRORCODE." + data.statusMsg.status));
            return;
        }
        if (data.count <= 0) {
            this.imgNoData.node.active = true;
            return;
        }
        let isTag = this.m_mapTagList.get(data.page);
        if (isTag) {
            return;
        }
        this.setContentSize(this.m_data.length + data.info.length);
        this.pushRenderItem(data.info);
        this.m_currPage = data.page;
        this.m_totalPage = data.count;
        this.m_mapTagList.set(data.page, true);
    }
    pushRenderItem(itemList) {
        this.m_isFrameLoadDone = false;
        let count = 0;
        for (let i = 0; i < itemList.length; ++i) {
            setTimeout(() => {
                this.appendItem(itemList[i]);
                if (++count >= itemList.length) {
                    this.m_isFrameLoadDone = true;
                }
            }, i * 16.67);
        }
    }
    appendItem(itemData) {
        let itemNode = cc.instantiate(this.pfbPBDepositReceiptItemNode);
        let itemSrc = itemNode.getComponent(PBDepositReceiptItemNode_1.default);
        itemSrc.setData(itemData);
        itemNode.x = 0;
        itemNode.y = 0 - (itemNode.height * 0.5) - (this.m_data.length * itemNode.height) - (this.m_data.length * INTERVAL_ROW_HEIGHT);
        this.scvList.content.addChild(itemNode);
        this.m_data.push(itemData);
        this.m_mapOperateSrc.set(itemData.id, itemSrc);
    }
    setContentSize(count) {
        let contentHeight = (count * this.m_itemSize.height) + ((count - 1) * INTERVAL_ROW_HEIGHT);
        if (contentHeight < this.scvList.content.parent.height) {
            contentHeight = this.scvList.content.parent.height;
        }
        this.scvList.content.height = contentHeight;
    }
    onExtractAmount(data) {
        if (data.statusMsg.status !== 0) {
            PanelHelp_1.default.showTip(Manager_1.Manager.makeLanguage("ERRORCODE." + data.statusMsg.status));
            return;
        }
        let itemSrc = this.m_mapOperateSrc.get(data.id);
        if (!itemSrc) {
            return;
        }
        let extractAmount = Number(itemSrc.data.amount);
        let expectedIncomeAmount = itemSrc.data.expectedIncome;
        PiggyBankData_1.default.getInstance().data.amount = Number(PiggyBankData_1.default.getInstance().data.amount) - extractAmount - expectedIncomeAmount;
        itemSrc.setStatus(protoc_1.com.bt.game.proto.hall.IncomeBreakdownStatus.EXTRACED);
        dispatch("CMD_UPDATE_PIGGY_BANK_DATA");
        dispatch("EVENT_EXTRACT_SUCCEED");
    }
    onCancelStoredAmount(data) {
        if (data.statusMsg.status !== 0) {
            PanelHelp_1.default.showTip(Manager_1.Manager.makeLanguage("ERRORCODE." + data.statusMsg.status));
            return;
        }
        let itemSrc = this.m_mapOperateSrc.get(data.id);
        if (!itemSrc) {
            return;
        }
        PanelHelp_1.default.showTip(LanguageImpl_1.i18n.PIGGY_BANK.CANCEL_SUCCESS);
        let extractAmount = Number(itemSrc.data.amount);
        PiggyBankData_1.default.getInstance().data.amount = Number(PiggyBankData_1.default.getInstance().data.amount) - extractAmount;
        PiggyBankData_1.default.getInstance().data.maxTransferAmount = Number(PiggyBankData_1.default.getInstance().data.maxTransferAmount) + extractAmount;
        PiggyBankData_1.default.getInstance().data.confirmAmount = Number(PiggyBankData_1.default.getInstance().data.confirmAmount) - extractAmount;
        itemSrc.setStatus(protoc_1.com.bt.game.proto.hall.IncomeBreakdownStatus.CANCELED);
        dispatch("CMD_UPDATE_PIGGY_BANK_DATA");
    }
    onClickClose() {
        this.playDefaultEffect("close");
        this.closeWithAction();
    }
};
__decorate([
    property(cc.ScrollView)
], PBDepositReceiptView.prototype, "scvList", void 0);
__decorate([
    property(cc.Sprite)
], PBDepositReceiptView.prototype, "imgNoData", void 0);
__decorate([
    property(cc.Prefab)
], PBDepositReceiptView.prototype, "pfbPBDepositReceiptItemNode", void 0);
__decorate([
    property(cc.Node)
], PBDepositReceiptView.prototype, "imgBase", void 0);
PBDepositReceiptView = __decorate([
    ccclass,
    Decorators_1.injectService(LobbyService_1.LobbyService.instance)
], PBDepositReceiptView);
exports.default = PBDepositReceiptView;

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0cy9zY3JpcHQvcGlnZ3lCYW5rL1BCRGVwb3NpdFJlY2VpcHRWaWV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsa0VBQXVEO0FBQ3ZELHVEQUFvRDtBQUNwRCwrREFBdUU7QUFDdkUsNkRBQTBEO0FBQzFELGtFQUEyRTtBQUMzRSx5REFBbUQ7QUFDbkQsb0VBQTRDO0FBQzVDLG9FQUE0QztBQUM1QywwRkFBa0U7QUFDbEUsb0VBQTRDO0FBRTVDLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQztBQUU1QyxXQUFXO0FBQ1gsTUFBTSxXQUFXLEdBQVcsRUFBRSxDQUFDO0FBQy9CLFFBQVE7QUFDUixNQUFNLG1CQUFtQixHQUFXLEVBQUUsQ0FBQztBQUt2QyxJQUFxQixvQkFBb0IsR0FBekMsTUFBcUIsb0JBQXFCLFNBQVEsZ0JBQU07SUFBeEQ7O1FBSVksWUFBTyxHQUFrQixJQUFJLENBQUM7UUFHOUIsY0FBUyxHQUFjLElBQUksQ0FBQztRQUc1QixnQ0FBMkIsR0FBYyxJQUFJLENBQUM7UUFHOUMsWUFBTyxHQUFZLElBQUksQ0FBQztRQUVoQyxNQUFNO1FBQ0UsZUFBVSxHQUFXLENBQUMsQ0FBQztRQUMvQixLQUFLO1FBQ0csZ0JBQVcsR0FBVyxDQUFDLENBQUM7UUFDaEMsS0FBSztRQUNHLFdBQU0sR0FBa0QsRUFBRSxDQUFDO1FBQ25FLFlBQVk7UUFDSixpQkFBWSxHQUF5QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3ZELFdBQVc7UUFDSCxzQkFBaUIsR0FBWSxLQUFLLENBQUM7UUFDM0MsT0FBTztRQUNDLGVBQVUsR0FBWSxJQUFJLENBQUM7UUFDbkMsWUFBWTtRQUNKLG9CQUFlLEdBQTBDLElBQUksR0FBRyxFQUFFLENBQUM7SUErTC9FLENBQUM7SUE3TFUsTUFBTSxDQUFDLFlBQVk7UUFDdEIsT0FBTyx3Q0FBd0MsQ0FBQztJQUNw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LEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsYUFBYSxDQUFDO1FBQ3hILE9BQU8sQ0FBQyxTQUFTLENBQUMsWUFBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV6RSxRQUFRLENBQUMsNEJBQTRCLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsWUFBWTtRQUNSLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDM0IsQ0FBQztDQUNKLENBQUE7QUF2Tkc7SUFEQyxRQUFRLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQztxREFDYztBQUd0QztJQURDLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDO3VEQUNnQjtBQUdwQztJQURDLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDO3lFQUNrQztBQUd0RDtJQURDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDO3FEQUNjO0FBYmYsb0JBQW9CO0lBRnhDLE9BQU87SUFDUCwwQkFBYSxDQUFDLDJCQUFZLENBQUMsUUFBUSxDQUFDO0dBQ2hCLG9CQUFvQixDQTJOeEM7a0JBM05vQixvQkFBb0IiLCJmaWxlIjoiIiwic291cmNlUm9vdCI6Ii8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpMThuIH0gZnJvbSBcIi4uL2NvbW1vbi9sYW5ndWFnZS9MYW5ndWFnZUltcGxcIjtcbmltcG9ydCB7IE1hbmFnZXIgfSBmcm9tIFwiLi4vY29tbW9uL21hbmFnZXIvTWFuYWdlclwiO1xuaW1wb3J0IHsgcHJvdG9QYWNrYWdlLCBzZXJ2ZXJUeXBlIH0gZnJvbSBcIi4uL2NvbW1vbi9uZXQvQ29tbW9uU2VydmljZVwiO1xuaW1wb3J0IHsgTG9iYnlTZXJ2aWNlIH0gZnJvbSBcIi4uL2NvbW1vbi9uZXQvTG9iYnlTZXJ2aWNlXCI7XG5pbXBvcnQgeyBpbmplY3RTZXJ2aWNlLCBtYWtlS2V5IH0gZnJvbSBcIi4uL2ZyYW1ld29yay9kZWNvcmF0b3IvRGVjb3JhdG9yc1wiO1xuaW1wb3J0IHsgY29tIH0gZnJvbSBcIi4uL2ZyYW1ld29yay9leHRlcm5hbC9wcm90b2NcIjtcbmltcG9ydCBVSVZpZXcgZnJvbSBcIi4uL2ZyYW1ld29yay91aS9VSVZpZXdcIjtcbmltcG9ydCBQYW5lbEhlbHAgZnJvbSBcIi4uL21zZ2JveC9QYW5lbEhlbHBcIjtcbmltcG9ydCBQQkRlcG9zaXRSZWNlaXB0SXRlbU5vZGUgZnJvbSBcIi4vUEJEZXBvc2l0UmVjZWlwdEl0ZW1Ob2RlXCI7XG5pbXBvcnQgUGlnZ3lCYW5rRGF0YSBmcm9tIFwiLi9QaWdneUJhbmtEYXRhXCI7XG5cbmNvbnN0IHsgY2NjbGFzcywgcHJvcGVydHkgfSA9IGNjLl9kZWNvcmF0b3I7XG5cbi8vIOm7mOiupOavj+mhteivt+axguihjOaVsFxuY29uc3QgREVGQVVMVF9ST1c6IG51bWJlciA9IDMwO1xuLy8g6KGM6Ze06ZqU6auY5bqmXG5jb25zdCBJTlRFUlZBTF9ST1dfSEVJR0hUOiBudW1iZXIgPSAxMDtcblxuXG5AY2NjbGFzc1xuQGluamVjdFNlcnZpY2UoTG9iYnlTZXJ2aWNlLmluc3RhbmNlKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUEJEZXBvc2l0UmVjZWlwdFZpZXcgZXh0ZW5kcyBVSVZpZXcge1xuICAgIHNlcnZpY2U6IExvYmJ5U2VydmljZTtcblxuICAgIEBwcm9wZXJ0eShjYy5TY3JvbGxWaWV3KVxuICAgIHByaXZhdGUgc2N2TGlzdDogY2MuU2Nyb2xsVmlldyA9IG51bGw7XG5cbiAgICBAcHJvcGVydHkoY2MuU3ByaXRlKVxuICAgIHByaXZhdGUgaW1nTm9EYXRhOiBjYy5TcHJpdGUgPSBudWxsO1xuXG4gICAgQHByb3BlcnR5KGNjLlByZWZhYilcbiAgICBwcml2YXRlIHBmYlBCRGVwb3NpdFJlY2VpcHRJdGVtTm9kZTogY2MuUHJlZmFiID0gbnVsbDtcblxuICAgIEBwcm9wZXJ0eShjYy5Ob2RlKVxuICAgIHByaXZhdGUgaW1nQmFzZTogY2MuTm9kZSA9IG51bGw7XG4gICAgXG4gICAgLy8g5b2T5YmN6aG1XG4gICAgcHJpdmF0ZSBtX2N1cnJQYWdlOiBudW1iZXIgPSAxO1xuICAgIC8vIOaAu+mhtVxuICAgIHByaXZhdGUgbV90b3RhbFBhZ2U6IG51bWJlciA9IDA7XG4gICAgLy8g5pWw5o2uXG4gICAgcHJpdmF0ZSBtX2RhdGE6IGNvbS5idC5nYW1lLnByb3RvLmhhbGwuSUluY29tZUJyZWFrZG93bkluZm9bXSA9IFtdO1xuICAgIC8vIOagh+iusOaYr+WQpuaLvOaOpeWujOaVsOaNrlxuICAgIHByaXZhdGUgbV9tYXBUYWdMaXN0OiBNYXA8bnVtYmVyLCBib29sZWFuPiA9IG5ldyBNYXAoKTtcbiAgICAvLyDmmK/lkKbliIbluKfliqDovb3lrozmiJBcbiAgICBwcml2YXRlIG1faXNGcmFtZUxvYWREb25lOiBib29sZWFuID0gZmFsc2U7XG4gICAgLy8g5Y2V6aG55a696auYXG4gICAgcHJpdmF0ZSBtX2l0ZW1TaXplOiBjYy5TaXplID0gbnVsbDtcbiAgICAvLyDkv53lrZjmr4/mnaHmk43kvZznmoTohJrmnKxcbiAgICBwcml2YXRlIG1fbWFwT3BlcmF0ZVNyYzogTWFwPHN0cmluZywgUEJEZXBvc2l0UmVjZWlwdEl0ZW1Ob2RlPiA9IG5ldyBNYXAoKTtcblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0UHJlZmFiVXJsKCkge1xuICAgICAgICByZXR1cm4gXCJwaWdneUJhbmsvcHJlZmFicy9QQkRlcG9zaXRSZWNlaXB0Vmlld1wiO1xuICAgIH1cblxuICAgIG9uTG9hZCgpIHtcbiAgICAgICAgc3VwZXIub25Mb2FkKCk7XG4gICAgICAgIHRoaXMuY29udGVudCA9IHRoaXMubm9kZS5nZXRDaGlsZEJ5TmFtZSgnaW1nQmcnKTtcbiAgICAgICAgdGhpcy5pbml0VmlldygpO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICBpZih0aGlzLmltZ0Jhc2Upe1xuICAgICAgICAgICAgbGV0IGxhYlRpbWUgPSB0aGlzLmltZ0Jhc2UuZ2V0Q2hpbGRCeU5hbWUoJ2xhYlRpbWUnKTtcbiAgICAgICAgICAgIGxhYlRpbWUuZ2V0Q29tcG9uZW50KGNjLkxhYmVsKS5sYW5ndWFnZSA9IGkxOG4uUElHR1lfQkFOSy5USU1FO1xuXG4gICAgICAgICAgICBsZXQgbGFiT3BlcmF0aW9uQW1vdW50LGxhYkludGVyZXN0UmF0ZSxsYWJFeHBlY3RlZFJldHVybixsYWJUaW1lTGVmdCxsYWJPcGVyYXRlO1xuICAgICAgICAgICAgbGFiT3BlcmF0aW9uQW1vdW50ID0gdGhpcy5pbWdCYXNlLmdldENoaWxkQnlOYW1lKCdsYWJPcGVyYXRpb25BbW91bnQnKTtcbiAgICAgICAgICAgIGxhYk9wZXJhdGlvbkFtb3VudC5nZXRDb21wb25lbnQoY2MuTGFiZWwpLmxhbmd1YWdlID0gaTE4bi5QSUdHWV9CQU5LLk9QRVJBVElPTl9BTU9VTlQ7XG5cbiAgICAgICAgICAgIGxhYkludGVyZXN0UmF0ZSA9IHRoaXMuaW1nQmFzZS5nZXRDaGlsZEJ5TmFtZSgnbGFiSW50ZXJlc3RSYXRlJyk7XG4gICAgICAgICAgICBsYWJJbnRlcmVzdFJhdGUuZ2V0Q29tcG9uZW50KGNjLkxhYmVsKS5sYW5ndWFnZSA9IGkxOG4uUElHR1lfQkFOSy5JTlRFUkVTUkFURTtcblxuICAgICAgICAgICAgbGFiRXhwZWN0ZWRSZXR1cm4gPSB0aGlzLmltZ0Jhc2UuZ2V0Q2hpbGRCeU5hbWUoJ2xhYkV4cGVjdGVkUmV0dXJuJyk7XG4gICAgICAgICAgICBsYWJFeHBlY3RlZFJldHVybi5nZXRDb21wb25lbnQoY2MuTGFiZWwpLmxhbmd1YWdlID0gaTE4bi5QSUdHWV9CQU5LLkVYUEVDVEVEUkVUVVJOO1xuXG4gICAgICAgICAgICBsYWJUaW1lTGVmdCA9IHRoaXMuaW1nQmFzZS5nZXRDaGlsZEJ5TmFtZSgnbGFiVGltZUxlZnQnKTtcbiAgICAgICAgICAgIGxhYlRpbWVMZWZ0LmdldENvbXBvbmVudChjYy5MYWJlbCkubGFuZ3VhZ2UgPSBpMThuLlBJR0dZX0JBTksuVElNRUxFRlQ7XG5cbiAgICAgICAgICAgIGxhYk9wZXJhdGUgPSB0aGlzLmltZ0Jhc2UuZ2V0Q2hpbGRCeU5hbWUoJ2xhYk9wZXJhdGUnKTtcbiAgICAgICAgICAgIGxhYk9wZXJhdGUuZ2V0Q29tcG9uZW50KGNjLkxhYmVsKS5sYW5ndWFnZSA9IGkxOG4uUElHR1lfQkFOSy5PUEVSQVRFO1xuXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBiaW5kaW5nRXZlbnRzKCkge1xuICAgICAgICB0aGlzLnNjdkxpc3Qubm9kZS5vbihcInNjcm9sbC10by1ib3R0b21cIiwgdGhpcy5vblNjcm9sbFRvQm90dG9tLCB0aGlzKTtcblxuICAgICAgICB0aGlzLnJlZ2lzdGVyRXZlbnQobWFrZUtleShzZXJ2ZXJUeXBlLkxvYmJ5LCBwcm90b1BhY2thZ2UuaGFsbC5IYWxsQ21kLkNNRF9JTkNPTUVfQlJFQUtET1dOKSwgdGhpcy5vbkluY29tZUJyZWFrZG93bik7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudChtYWtlS2V5KHNlcnZlclR5cGUuTG9iYnksIHByb3RvUGFja2FnZS5oYWxsLkhhbGxDbWQuQ01EX0VYVFJBQ1RfQU1PVU5UKSwgdGhpcy5vbkV4dHJhY3RBbW91bnQpO1xuICAgICAgICB0aGlzLnJlZ2lzdGVyRXZlbnQobWFrZUtleShzZXJ2ZXJUeXBlLkxvYmJ5LCBwcm90b1BhY2thZ2UuaGFsbC5IYWxsQ21kLkNNRF9DQU5DRUxfU1RPUkVEX0FNT1VOVCksIHRoaXMub25DYW5jZWxTdG9yZWRBbW91bnQpO1xuICAgIH1cblxuICAgIHNob3coKTogdm9pZCB7XG4gICAgICAgIHN1cGVyLnNob3coKTtcbiAgICAgICAgdGhpcy5zaG93V2l0aEFjdGlvbih0cnVlKTtcbiAgICAgICAgdGhpcy5yZXFQYWdlRGF0YSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdFZpZXcoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaW1nTm9EYXRhLm5vZGUuYWN0aXZlID0gZmFsc2U7XG4gICAgICAgIGxldCBpdGVtTm9kZTogY2MuTm9kZSA9IGNjLmluc3RhbnRpYXRlKHRoaXMucGZiUEJEZXBvc2l0UmVjZWlwdEl0ZW1Ob2RlKTtcbiAgICAgICAgdGhpcy5tX2l0ZW1TaXplID0gaXRlbU5vZGUuZ2V0Q29udGVudFNpemUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlcVBhZ2VEYXRhKCk6IHZvaWQge1xuICAgICAgICBsZXQgcmVxID0gcHJvdG9QYWNrYWdlLmhhbGwuSW5jb21lQnJlYWtkb3duUmVxLmNyZWF0ZSh7IGN1clBhZ2U6IHRoaXMubV9jdXJyUGFnZSwgcGFnZUNvdW50OiBERUZBVUxUX1JPVyB9KTtcbiAgICAgICAgbGV0IGJ1ZmZlciA9IHByb3RvUGFja2FnZS5oYWxsLkluY29tZUJyZWFrZG93blJlcS5lbmNvZGUocmVxKS5maW5pc2goKTtcbiAgICAgICAgdGhpcy5zZXJ2aWNlLnNlbmRNc2coc2VydmVyVHlwZS5Mb2JieSxcbiAgICAgICAgICAgIHByb3RvUGFja2FnZS5oYWxsLkhhbGxDbWQuQ01EX0lOQ09NRV9CUkVBS0RPV04sXG4gICAgICAgICAgICBidWZmZXIpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25TY3JvbGxUb0JvdHRvbSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLm1faXNGcmFtZUxvYWREb25lKSB7XG4gICAgICAgICAgICBHLkxvZ2dlci5sb2coXCLmnKrliqDovb3lrozmiJAgaXRlbSDotYTmupDvvIzml6Dms5Xojrflj5bmnIDmlrDmlbDmja5cIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5tX2N1cnJQYWdlID49IHRoaXMubV90b3RhbFBhZ2UpIHtcbiAgICAgICAgICAgIEcuTG9nZ2VyLmxvZyhcIui1hOa6kOW3suWKoOi9veWujOaIkO+8jOaXoOazlee7p+e7reiOt+WPluaVsOaNrlwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgICsrdGhpcy5tX2N1cnJQYWdlO1xuICAgICAgICB0aGlzLnJlcVBhZ2VEYXRhKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkluY29tZUJyZWFrZG93bihkYXRhOiBjb20uYnQuZ2FtZS5wcm90by5oYWxsLkluY29tZUJyZWFrZG93blJlcyk6IHZvaWQge1xuICAgICAgICBpZiAoZGF0YS5zdGF0dXNNc2cuc3RhdHVzICE9PSAwKSB7XG4gICAgICAgICAgICBQYW5lbEhlbHAuc2hvd1RpcChNYW5hZ2VyLm1ha2VMYW5ndWFnZShcIkVSUk9SQ09ERS5cIiArIGRhdGEuc3RhdHVzTXNnLnN0YXR1cykpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRhdGEuY291bnQgPD0gMCkge1xuICAgICAgICAgICAgdGhpcy5pbWdOb0RhdGEubm9kZS5hY3RpdmUgPSB0cnVlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGlzVGFnOiBib29sZWFuIHwgdW5kZWZpbmVkID0gdGhpcy5tX21hcFRhZ0xpc3QuZ2V0KGRhdGEucGFnZSk7XG5cbiAgICAgICAgaWYgKGlzVGFnKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNldENvbnRlbnRTaXplKHRoaXMubV9kYXRhLmxlbmd0aCArIGRhdGEuaW5mby5sZW5ndGgpO1xuXG4gICAgICAgIHRoaXMucHVzaFJlbmRlckl0ZW0oZGF0YS5pbmZvKTtcblxuICAgICAgICB0aGlzLm1fY3VyclBhZ2UgPSBkYXRhLnBhZ2U7XG4gICAgICAgIHRoaXMubV90b3RhbFBhZ2UgPSBkYXRhLmNvdW50O1xuXG4gICAgICAgIHRoaXMubV9tYXBUYWdMaXN0LnNldChkYXRhLnBhZ2UsIHRydWUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHVzaFJlbmRlckl0ZW0oaXRlbUxpc3Q6IGNvbS5idC5nYW1lLnByb3RvLmhhbGwuSUluY29tZUJyZWFrZG93bkluZm9bXSk6IHZvaWQge1xuICAgICAgICB0aGlzLm1faXNGcmFtZUxvYWREb25lID0gZmFsc2U7XG5cbiAgICAgICAgbGV0IGNvdW50OiBudW1iZXIgPSAwO1xuICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgaXRlbUxpc3QubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kSXRlbShpdGVtTGlzdFtpXSk7XG4gICAgICAgICAgICAgICAgaWYgKCsrY291bnQgPj0gaXRlbUxpc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubV9pc0ZyYW1lTG9hZERvbmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIGkgKiAxNi42Nyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFwcGVuZEl0ZW0oaXRlbURhdGE6IGNvbS5idC5nYW1lLnByb3RvLmhhbGwuSUluY29tZUJyZWFrZG93bkluZm8pOiB2b2lkIHtcbiAgICAgICAgbGV0IGl0ZW1Ob2RlOiBjYy5Ob2RlID0gY2MuaW5zdGFudGlhdGUodGhpcy5wZmJQQkRlcG9zaXRSZWNlaXB0SXRlbU5vZGUpO1xuICAgICAgICBsZXQgaXRlbVNyYzogUEJEZXBvc2l0UmVjZWlwdEl0ZW1Ob2RlID0gaXRlbU5vZGUuZ2V0Q29tcG9uZW50KFBCRGVwb3NpdFJlY2VpcHRJdGVtTm9kZSk7XG4gICAgICAgIGl0ZW1TcmMuc2V0RGF0YShpdGVtRGF0YSk7XG5cbiAgICAgICAgaXRlbU5vZGUueCA9IDA7XG4gICAgICAgIGl0ZW1Ob2RlLnkgPSAwIC0gKGl0ZW1Ob2RlLmhlaWdodCAqIDAuNSkgLSAodGhpcy5tX2RhdGEubGVuZ3RoICogaXRlbU5vZGUuaGVpZ2h0KSAtICh0aGlzLm1fZGF0YS5sZW5ndGggKiBJTlRFUlZBTF9ST1dfSEVJR0hUKTtcblxuICAgICAgICB0aGlzLnNjdkxpc3QuY29udGVudC5hZGRDaGlsZChpdGVtTm9kZSk7XG5cbiAgICAgICAgdGhpcy5tX2RhdGEucHVzaChpdGVtRGF0YSk7XG4gICAgICAgIHRoaXMubV9tYXBPcGVyYXRlU3JjLnNldChpdGVtRGF0YS5pZCwgaXRlbVNyYyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRDb250ZW50U2l6ZShjb3VudDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGxldCBjb250ZW50SGVpZ2h0OiBudW1iZXIgPSAoY291bnQgKiB0aGlzLm1faXRlbVNpemUuaGVpZ2h0KSArICgoY291bnQgLSAxKSAqIElOVEVSVkFMX1JPV19IRUlHSFQpO1xuICAgICAgICBpZiAoY29udGVudEhlaWdodCA8IHRoaXMuc2N2TGlzdC5jb250ZW50LnBhcmVudC5oZWlnaHQpIHtcbiAgICAgICAgICAgIGNvbnRlbnRIZWlnaHQgPSB0aGlzLnNjdkxpc3QuY29udGVudC5wYXJlbnQuaGVpZ2h0O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2N2TGlzdC5jb250ZW50LmhlaWdodCA9IGNvbnRlbnRIZWlnaHQ7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIG9uRXh0cmFjdEFtb3VudChkYXRhOiBjb20uYnQuZ2FtZS5wcm90by5oYWxsLkV4dHJhY3RBbW91bnRSZXMpOiB2b2lkIHtcbiAgICAgICAgaWYgKGRhdGEuc3RhdHVzTXNnLnN0YXR1cyAhPT0gMCkge1xuICAgICAgICAgICAgUGFuZWxIZWxwLnNob3dUaXAoTWFuYWdlci5tYWtlTGFuZ3VhZ2UoXCJFUlJPUkNPREUuXCIgKyBkYXRhLnN0YXR1c01zZy5zdGF0dXMpKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpdGVtU3JjOiBQQkRlcG9zaXRSZWNlaXB0SXRlbU5vZGUgfCB1bmRlZmluZWQgPSB0aGlzLm1fbWFwT3BlcmF0ZVNyYy5nZXQoZGF0YS5pZCk7XG4gICAgICAgIGlmICghaXRlbVNyYykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGV4dHJhY3RBbW91bnQ6IG51bWJlciA9IE51bWJlcihpdGVtU3JjLmRhdGEuYW1vdW50KTtcbiAgICAgICAgbGV0IGV4cGVjdGVkSW5jb21lQW1vdW50OiBudW1iZXIgPSBpdGVtU3JjLmRhdGEuZXhwZWN0ZWRJbmNvbWU7XG5cbiAgICAgICAgUGlnZ3lCYW5rRGF0YS5nZXRJbnN0YW5jZSgpLmRhdGEuYW1vdW50ID0gTnVtYmVyKFBpZ2d5QmFua0RhdGEuZ2V0SW5zdGFuY2UoKS5kYXRhLmFtb3VudCkgLSBleHRyYWN0QW1vdW50IC0gZXhwZWN0ZWRJbmNvbWVBbW91bnQ7XG4gICAgICAgIGl0ZW1TcmMuc2V0U3RhdHVzKGNvbS5idC5nYW1lLnByb3RvLmhhbGwuSW5jb21lQnJlYWtkb3duU3RhdHVzLkVYVFJBQ0VEKTtcblxuICAgICAgICBkaXNwYXRjaChcIkNNRF9VUERBVEVfUElHR1lfQkFOS19EQVRBXCIpO1xuICAgICAgICBkaXNwYXRjaChcIkVWRU5UX0VYVFJBQ1RfU1VDQ0VFRFwiKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ2FuY2VsU3RvcmVkQW1vdW50KGRhdGE6IGNvbS5idC5nYW1lLnByb3RvLmhhbGwuQ2FuY2VsU3RvcmVkQW1vdW50UmVzKTogdm9pZCB7XG4gICAgICAgIGlmIChkYXRhLnN0YXR1c01zZy5zdGF0dXMgIT09IDApIHtcbiAgICAgICAgICAgIFBhbmVsSGVscC5zaG93VGlwKE1hbmFnZXIubWFrZUxhbmd1YWdlKFwiRVJST1JDT0RFLlwiICsgZGF0YS5zdGF0dXNNc2cuc3RhdHVzKSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaXRlbVNyYzogUEJEZXBvc2l0UmVjZWlwdEl0ZW1Ob2RlIHwgdW5kZWZpbmVkID0gdGhpcy5tX21hcE9wZXJhdGVTcmMuZ2V0KGRhdGEuaWQpO1xuICAgICAgICBpZiAoIWl0ZW1TcmMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIFBhbmVsSGVscC5zaG93VGlwKGkxOG4uUElHR1lfQkFOSy5DQU5DRUxfU1VDQ0VTUyk7XG5cbiAgICAgICAgbGV0IGV4dHJhY3RBbW91bnQ6IG51bWJlciA9IE51bWJlcihpdGVtU3JjLmRhdGEuYW1vdW50KTtcblxuICAgICAgICBQaWdneUJhbmtEYXRhLmdldEluc3RhbmNlKCkuZGF0YS5hbW91bnQgPSBOdW1iZXIoUGlnZ3lCYW5rRGF0YS5nZXRJbnN0YW5jZSgpLmRhdGEuYW1vdW50KSAtIGV4dHJhY3RBbW91bnQ7XG4gICAgICAgIFBpZ2d5QmFua0RhdGEuZ2V0SW5zdGFuY2UoKS5kYXRhLm1heFRyYW5zZmVyQW1vdW50ID0gTnVtYmVyKFBpZ2d5QmFua0RhdGEuZ2V0SW5zdGFuY2UoKS5kYXRhLm1heFRyYW5zZmVyQW1vdW50KSArIGV4dHJhY3RBbW91bnQ7XG4gICAgICAgIFBpZ2d5QmFua0RhdGEuZ2V0SW5zdGFuY2UoKS5kYXRhLmNvbmZpcm1BbW91bnQgPSBOdW1iZXIoUGlnZ3lCYW5rRGF0YS5nZXRJbnN0YW5jZSgpLmRhdGEuY29uZmlybUFtb3VudCkgLSBleHRyYWN0QW1vdW50O1xuICAgICAgICBpdGVtU3JjLnNldFN0YXR1cyhjb20uYnQuZ2FtZS5wcm90by5oYWxsLkluY29tZUJyZWFrZG93blN0YXR1cy5DQU5DRUxFRCk7XG5cbiAgICAgICAgZGlzcGF0Y2goXCJDTURfVVBEQVRFX1BJR0dZX0JBTktfREFUQVwiKTtcbiAgICB9XG5cbiAgICBvbkNsaWNrQ2xvc2UoKTogdm9pZCB7XG4gICAgICAgIHRoaXMucGxheURlZmF1bHRFZmZlY3QoXCJjbG9zZVwiKTtcbiAgICAgICAgdGhpcy5jbG9zZVdpdGhBY3Rpb24oKTtcbiAgICB9XG59XG4iXX0=