{"version":3,"sources":["assets/script/update/Updating.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { AssetManagerCode, AssetManagerState, HotUpdate } from \"../common/base/HotUpdate\";\nimport { Config } from \"../common/config/Config\";\nimport { dispatchEnterComplete, LogicEvent, LogicType } from \"../common/event/LogicEvent\";\nimport { i18n } from \"../common/language/LanguageImpl\";\nimport { LobbyService } from \"../common/net/LobbyService\";\nimport { RequestPackge } from \"../framework/net/HttpClient\";\nimport UIView from \"../framework/ui/UIView\";\nimport { reStartGame } from \"../global/Global\";\nimport { HallEvent } from \"../hall/HallEvent\";\nimport PanelHelp from \"../msgbox/PanelHelp\";\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class Updating extends UIView {\n\n   @property(cc.Label)\n   progressLabel: cc.Label = null;\n\n   @property(cc.ProgressBar)\n   progressBar: cc.ProgressBar = null;\n\n   private updateFailedNum = 0;\n\n   // LIFE-CYCLE CALLBACKS:\n\n   onLoad() {\n      super.onLoad();\n      this.className = \"Updating\";\n      this.progressLabel.string = \"\";\n      this.progressBar.progress = 0;\n      this.progressBar.node.active = false;\n   }\n   bindingEvents() {\n      super.bindingEvents();\n      this.registerEvent(HallEvent.DOWNLOAD_PROGRESS, this.onDownloadProgess);\n   }\n\n   private onDownloadProgess(data: { progress: number }) {\n      if (cc.isValid(this.node)) {\n         if (data.progress == -1) {\n            this.progressBar.node.active = false;\n            PanelHelp.showMsgBox(\"\", i18n.TIPS.DOWNLOADFAILED, () => {\n               this.checkUpdate()\n            })\n         } else if (data.progress <= 1) {\n            this.progressBar.node.active = true;\n            if (data.progress > this.progressBar.progress ) {\n               this.progressBar.progress = data.progress;\n               this.progressLabel.string = \"\" + Math.floor(data.progress * 100) + \"%\";\n            }\n         } else {\n            this.progressBar.node.active = false;\n         }\n      }\n   }\n\n   async start() {\n      \n      if (!Config.isOpenHotUpdate) {\n         this.hide();\n         dispatch(LogicEvent.ENTER_LOGIN);\n         return;\n      }\n      \n      PanelHelp.hideLoading();\n      \n      if (cc.sys.os === cc.sys.OS_ANDROID && cc.sys.isNative) {\n         let version = window['platformUtil'].getVersionName();\n         if (version &&  G.URLMgr.apkVersion) {//强制更新apk 小于服务器版本才更新\n            if (this.compareVersion(version) < 0) {\n               PanelHelp.showMsgBox('', i18n.TIPS.VERSIONUPDATE, () => {\n                  cc.sys.openURL(G.URLMgr.apkURL)\n               }, i18n.TIPS.UPDATE, false, false)\n            }else{\n               this.checkUpdate()\n            }\n         } else {\n            this.checkUpdate()\n         }\n      } else {\n         this.checkUpdate()\n      }\n   }\n   private compareVersion(version){\n      let vA = version.split('.');\n      let vB = G.URLMgr.apkVersion.split('.');\n      for (let i = 0; i < vA.length && i < vB.length; ++i) {\n         let a = parseInt(vA[i]);\n         let b = parseInt(vB[i]);\n         if (a === b) {\n             continue;\n         }\n         else {\n             return a - b;\n         }\n     }\n     if (vB.length > vA.length) {\n         return -1;\n     }\n     return 0;\n   }\n\n   checkUpdate() {\n      HotUpdate.checkHallUpdate((code, state) => {\n         G.Logger.log('checkHallUpdate = ', code);\n\n         if (code == AssetManagerCode.NEW_VERSION_FOUND) {\n            //有新版本\n            HotUpdate.onDownload = this.onDownload.bind(this);\n            cc.log(`检测到有新的版本`);\n            HotUpdate.hotUpdate();\n            this.progressBar.node.active = true;\n         } else if (state == AssetManagerState.TRY_DOWNLOAD_FAILED_ASSETS) {\n            //尝试重新下载之前下载失败的文件\n            HotUpdate.onDownload = this.onDownload.bind(this);\n            cc.log(`正在尝试重新下载之前下载失败的资源`);\n            HotUpdate.downloadFailedAssets();\n         } else if (code == AssetManagerCode.UPDATE_FINISHED) {\n            //更新完成\n            reStartGame()//重启游戏\n         }else if (code == AssetManagerCode.ALREADY_UP_TO_DATE) {\n            //已经是最新版本\n            this.hide();\n            dispatch('RefreshVersion')\n            PanelHelp.showLoading(i18n.WAIT.LOADING,true)\n            dispatch(LogicEvent.ENTER_LOGIN);\n         } else if (code == AssetManagerCode.ERROR_DOWNLOAD_MANIFEST ||\n            code == AssetManagerCode.ERROR_NO_LOCAL_MANIFEST ||\n            code == AssetManagerCode.ERROR_PARSE_MANIFEST) {\n            //下载manifest文件失败\n            // this.isLoading = false;\n            let content = \"下载版本文件失败!\";\n            if (code == AssetManagerCode.ERROR_NO_LOCAL_MANIFEST) {\n               content = \"找不到版本文件!\";\n            } else if (code == AssetManagerCode.ERROR_PARSE_MANIFEST) {\n               content = \"版本文件解析错误!\";\n            }\n            //Manager.toast.show(content);\n         } else if (code == AssetManagerCode.CHECKING) {\n            //当前正在检测更新\n            cc.log(`正在检测更新!!`);\n         } else {\n            // this.isLoading = false;\n            cc.log(`检测更新当前状态 code : ${code} state : ${state}`);\n         }\n      });\n   }\n   private onDownload(\n      downloadedBytes: number,\n      totalBytes: number,\n      downloadedFiles: number,\n      totalFiles: number,\n      percent: number,\n      percentByFile: number,\n      code: AssetManagerCode,\n      state: AssetManagerState,\n      needRestart: boolean) {\n      if (CC_DEBUG) cc.log(`\n                downloadedBytes : ${downloadedBytes}\n                totalBytes : ${totalBytes}\n                downloadedFiles : ${downloadedFiles}\n                totalFiles : ${totalFiles}\n                percent : ${percent}\n                percentByFile : ${percentByFile}\n                code : ${code}\n                state : ${state}\n                needRestart : ${needRestart}\n                `);\n      let newPercent = 0;\n\n      /**\n       *  @description 找不到本地mainfest文件\n      ERROR_NO_LOCAL_MANIFEST,\n      @description 下载manifest文件错误 \n      ERROR_DOWNLOAD_MANIFEST,\n      /**@description 解析manifest文件错误 \n       ERROR_PARSE_MANIFEST,\n      /**@description 找到新版本 \n       NEW_VERSION_FOUND,\n      /**@description 当前已经是最新版本 \n       ALREADY_UP_TO_DATE,\n      /**@description 更新下载进度中 \n       UPDATE_PROGRESSION,\n      /**@description 资源更新中 \n       ASSET_UPDATED,\n      /**@description 更新错误 \n       ERROR_UPDATING,\n      /**@description 更新完成 \n       UPDATE_FINISHED,\n      /**@description 更新失败 \n       UPDATE_FAILED,\n      /**@description 解压资源失败 \n       ERROR_DECOMPRESS,\n       */\n\n      if (code == AssetManagerCode.UPDATE_PROGRESSION) {\n         newPercent = percentByFile == Number.NaN ? 0 : percentByFile;\n         //    dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent, config: gameConfig });\n         dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent });\n      } else if (code == AssetManagerCode.ALREADY_UP_TO_DATE) {\n         newPercent = 1;\n         dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent });\n         //    dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent, config: gameConfig });\n      } else if (code == AssetManagerCode.UPDATE_FINISHED) {\n         newPercent = 1.1;\n         this.updateFailedNum = 0;\n         cc.log(`更新成功`);\n         setTimeout(()=>{\n            dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent});\n           },500)\n         //    dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent, config: gameConfig });\n      } else if (code == AssetManagerCode.UPDATE_FAILED ||\n         code == AssetManagerCode.ERROR_NO_LOCAL_MANIFEST ||\n         code == AssetManagerCode.ERROR_DOWNLOAD_MANIFEST ||\n         code == AssetManagerCode.ERROR_PARSE_MANIFEST ||\n         code == AssetManagerCode.ERROR_DECOMPRESS) {\n            this.updateFailedNum++\n            if (this.updateFailedNum < 4) {//失败后自动更新\n               this.checkUpdate()\n            }else{\n               newPercent = -1;\n               //    this.isLoading = false;\n                  cc.error(`更新失败`);\n                  dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent});\n               //    dispatch(HallEvent.DOWNLOAD_PROGRESS, { progress: newPercent, config: gameConfig });\n            }\n      }\n   }\n   \n   // update (dt) {}\n}\n"]}